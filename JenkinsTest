pipeline {
    agent any

    environment {
        // Set these environment variables globally within the pipeline
        WORKSPACE_DIR = "${pwd()}"
        TEMP_DIR = "${WORKSPACE_DIR}/tempdir"
    }

    stages {
        stage('Sync Files') {
            steps {
                sh 'chmod +x old_scripts/Sync_files.sh'
                sh 'old_scripts/Sync_files.sh'
            }
        }

        stage('Run Tests and Transfer Image') {
            parallel {
                clienttests: {
                    try {
                        echo 'Running client Tests'
                        dotnetTest project: "${env.TEMP_DIR}/Rise.Client.Tests/", unstableIfWarnings: true
                    } catch (Exception e) {
                        echo 'Client Tests failed: ' + e.message
                    }
                },
                domaintests: {
                    try {
                        echo 'Running Domain Tests'
                        dotnetTest project: "${env.TEMP_DIR}/Rise.Domain.Tests/", unstableIfWarnings: true
                    } catch (Exception e) {
                        echo 'Domain Tests failed: ' + e.message
                    }
                },
                servertests: {
                    try {
                        echo 'Running Server Tests'
                        dotnetTest project: "${env.TEMP_DIR}/Rise.Server.Tests/", unstableIfWarnings: true
                    } catch (Exception e) {
                        echo 'Server Tests failed: ' + e.message
                    }
                },
                playwrighttests: {
                    try {
                        echo 'Running Playwright Tests'
                        dotnetTest project: "${env.TEMP_DIR}/Rise.PlaywrightTests/", unstableIfWarnings: true
                    } catch (Exception e) {
                        echo 'Playwright Tests failed: ' + e.message
                    }
                }
            }
        }
    }
}
